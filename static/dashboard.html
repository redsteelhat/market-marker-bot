<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Maker Bot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #151528;
            --bg-card: rgba(26, 26, 46, 0.8);
            --bg-card-hover: rgba(30, 30, 56, 0.95);
            --border-color: rgba(96, 165, 250, 0.2);
            --text-primary: #e8e8f0;
            --text-secondary: #9ca3af;
            --accent-blue: #60a5fa;
            --accent-green: #4ade80;
            --accent-red: #ef4444;
            --accent-yellow: #fbbf24;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 0 20px rgba(96, 165, 250, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            background-image: 
                radial-gradient(at 0% 0%, rgba(96, 165, 250, 0.1) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(74, 222, 128, 0.1) 0px, transparent 50%);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 24px 32px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .header:hover {
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            transform: translateY(-2px);
        }

        .header h1 {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-red);
            box-shadow: 0 0 10px var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }

        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.6; 
                transform: scale(1.1);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            background: var(--bg-card-hover);
            box-shadow: var(--shadow-lg);
            transform: translateY(-4px);
            border-color: rgba(96, 165, 250, 0.4);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h2 {
            color: var(--accent-blue);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(96, 165, 250, 0.2);
            padding-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(96, 165, 250, 0.1);
            transition: all 0.2s ease;
        }

        .metric:hover {
            background: rgba(96, 165, 250, 0.05);
            margin: 0 -12px;
            padding-left: 12px;
            padding-right: 12px;
            border-radius: 8px;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .metric-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .metric-value.positive {
            color: var(--accent-green);
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
        }

        .metric-value.negative {
            color: var(--accent-red);
            text-shadow: 0 0 10px rgba(239, 68, 68, 0.3);
        }

        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
        }

        .positions-table th,
        .positions-table td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(96, 165, 250, 0.1);
        }

        .positions-table thead {
            background: rgba(96, 165, 250, 0.1);
        }

        .positions-table th {
            color: var(--accent-blue);
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .positions-table tbody tr {
            transition: all 0.2s ease;
        }

        .positions-table tbody tr:hover {
            background: rgba(96, 165, 250, 0.05);
        }

        .positions-table td {
            color: var(--text-primary);
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        .badge.long {
            background: var(--gradient-success);
            color: #0a0a1a;
        }

        .badge.short {
            background: var(--gradient-danger);
            color: #fff;
        }

        .badge.flat {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: #fff;
        }

        .badge.risk-off {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #0a0a1a;
        }

        .trades-list {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
        }

        .trade-item {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(96, 165, 250, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .trade-item:hover {
            background: rgba(96, 165, 250, 0.05);
            transform: translateX(4px);
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .trade-side {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-sm);
        }

        .trade-side.BUY {
            background: var(--gradient-success);
            color: #0a0a1a;
        }

        .trade-side.SELL {
            background: var(--gradient-danger);
            color: #fff;
        }

        .logs-container {
            background: rgba(10, 10, 26, 0.6);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .log-entry {
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
            word-break: break-word;
            padding: 8px 12px;
            margin-bottom: 4px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .log-entry:hover {
            background: rgba(96, 165, 250, 0.1);
            transform: translateX(4px);
        }

        .price-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .price-item:hover {
            background: rgba(96, 165, 250, 0.1);
            border-color: var(--border-color);
            transform: translateX(4px);
        }

        .price-value {
            transition: all 0.3s ease;
            font-weight: 700;
        }

        @keyframes priceUpdate {
            0% { 
                opacity: 1; 
                transform: scale(1);
            }
            50% { 
                opacity: 0.7; 
                transform: scale(1.05);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
            }
        }

        .price-updated {
            animation: priceUpdate 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timestamp {
            color: #9ca3af;
            font-size: 12px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }

        .error {
            background: #7f1d1d;
            color: #fca5a5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #4f9ffa 0%, #6a3ba8 100%);
        }

        /* Button styles */
        button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        button:active {
            transform: translateY(0);
        }

        /* Input styles */
        input, select {
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
        }

        /* Loading animation */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        .loading {
            background: linear-gradient(
                90deg,
                var(--bg-secondary) 0%,
                rgba(96, 165, 250, 0.1) 50%,
                var(--bg-secondary) 100%
            );
            background-size: 1000px 100%;
            animation: shimmer 2s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Market Maker Bot Dashboard</h1>
            <div class="status">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>

        <div id="errorContainer"></div>

        <div class="grid" id="dashboardGrid">
            <div class="loading">Loading dashboard...</div>
        </div>
    </div>

    <script>
        let ws = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        
        // Backtest state to preserve across HTML updates
        let backtestState = {
            loaderVisible: false,
            resultsVisible: false,
            resultsContent: null
        };
        
        // Coin selection state to preserve across HTML updates
        let coinSelectionState = {
            selectedCoins: []
        };
        
        // Price state to track previous prices for animations
        let previousPrices = {};
        
        // Flag to ensure event listener is only attached once
        let backtestListenerAttached = false;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                updateStatus(true);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'update') {
                        const prices = message.data.prices || {};
                        const priceKeys = Object.keys(prices);
                        if (priceKeys.length > 0) {
                            const firstPrice = prices[priceKeys[0]];
                            console.log('Dashboard update received:', {
                                prices_count: priceKeys.length,
                                symbols: priceKeys,
                                first_price: firstPrice ? {
                                    mid: firstPrice.mid_price,
                                    bid: firstPrice.best_bid,
                                    ask: firstPrice.best_ask
                                } : null,
                                selected_coins: message.data.selected_coins,
                                timestamp: message.data.last_update
                            });
                        }
                        updateDashboard(message.data);
                    }
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateStatus(false);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected');
                updateStatus(false);
                
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    setTimeout(connectWebSocket, 2000 * reconnectAttempts);
                } else {
                    showError('Failed to connect to dashboard server. Please check if the bot is running.');
                }
            };
        }

        function updateStatus(connected) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (connected) {
                indicator.classList.add('connected');
                text.textContent = 'Connected';
            } else {
                indicator.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error">${message}</div>`;
        }

        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return 'N/A';
            return Number(num).toFixed(decimals);
        }

        function formatCurrency(num) {
            return `$${formatNumber(num)}`;
        }

        function formatPercent(num) {
            if (num === null || num === undefined) return 'N/A';
            return `${formatNumber(num * 100)}%`;
        }

        function formatTimestamp(isoString) {
            if (!isoString) return 'N/A';
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function updateDashboard(data) {
            const grid = document.getElementById('dashboardGrid');
            
            if (!data.bot_running) {
                grid.innerHTML = '<div class="loading">Bot is not running</div>';
                return;
            }

            let html = '';

            // Binance Balance Card
            const balance = data.balance;
            if (balance && balance.usdt_balance) {
                html += `
                <div class="card">
                    <h2>üíµ Binance Balance</h2>
                    <div class="metric">
                        <span class="metric-label">Available USDT</span>
                        <span class="metric-value" style="color: #4ade80; font-size: 24px; font-weight: 700;">
                            ${formatCurrency(balance.usdt_balance.available || 0)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total USDT</span>
                        <span class="metric-value">${formatCurrency(balance.usdt_balance.total || 0)}</span>
                    </div>
                    ${balance.total_wallet_balance ? `
                    <div class="metric">
                        <span class="metric-label">Total Wallet Balance</span>
                        <span class="metric-value">${formatCurrency(balance.total_wallet_balance)}</span>
                    </div>
                    ` : ''}
                    ${balance.total_unrealized_pnl !== undefined ? `
                    <div class="metric">
                        <span class="metric-label">Unrealized PnL</span>
                        <span class="metric-value ${balance.total_unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(balance.total_unrealized_pnl)}
                        </span>
                    </div>
                    ` : ''}
                </div>
                `;
            }

            // Coin Selection Card
            const availableCoins = ['BTCUSDT', 'ETHUSDT', 'BNBUSDT', 'SOLUSDT', 'ADAUSDT', 'XRPUSDT', 'DOGEUSDT', 'DOTUSDT', 'MATICUSDT', 'AVAXUSDT'];
            // Use server state if available, otherwise use client state
            const selectedCoins = data.selected_coins && data.selected_coins.length > 0 ? data.selected_coins : (coinSelectionState.selectedCoins.length > 0 ? coinSelectionState.selectedCoins : []);
            // Update client state
            coinSelectionState.selectedCoins = selectedCoins;
            html += `
                <div class="card">
                    <h2>üéØ Track Coins</h2>
                    <div style="padding: 10px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px;">
                            ${availableCoins.map(coin => `
                                <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; background: ${selectedCoins.includes(coin) ? '#1a3a1a' : '#1a1a3a'}; border-radius: 4px; border: 1px solid ${selectedCoins.includes(coin) ? '#4ade80' : '#2a2a4a'};">
                                    <input type="checkbox" class="coin-checkbox" value="${coin}" ${selectedCoins.includes(coin) ? 'checked' : ''} 
                                           style="margin-right: 8px; cursor: pointer;">
                                    <span style="color: #e0e0e0; font-size: 13px;">${coin}</span>
                                </label>
                            `).join('')}
                        </div>
                        <button id="updateCoinsBtn" style="width: 100%; padding: 10px; background: #60a5fa; color: #0f0f23; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
                            Update Selected Coins
                        </button>
                    </div>
                </div>
            `;

            // Trading Signals Card
            const signals = data.signals || [];
            html += `
                <div class="card full-width">
                    <h2>üì° Trading Signals</h2>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${signals.length > 0 ? `
                            ${signals.slice().reverse().map(signal => {
                                const signalColors = {
                                    'ENTER_LONG': { bg: '#1a3a1a', border: '#4ade80', text: '#4ade80', icon: 'üìà' },
                                    'ENTER_SHORT': { bg: '#3a1a1a', border: '#ef4444', text: '#ef4444', icon: 'üìâ' },
                                    'EXIT_LONG': { bg: '#3a3a1a', border: '#fbbf24', text: '#fbbf24', icon: 'üîÑ' },
                                    'EXIT_SHORT': { bg: '#3a3a1a', border: '#fbbf24', text: '#fbbf24', icon: 'üîÑ' },
                                };
                                const colors = signalColors[signal.signal_type] || { bg: '#1a1a3a', border: '#60a5fa', text: '#60a5fa', icon: '‚ö°' };
                                return `
                                    <div style="padding: 12px; margin-bottom: 8px; background: ${colors.bg}; border-left: 4px solid ${colors.border}; border-radius: 4px;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="font-size: 18px; margin-right: 8px;">${colors.icon}</span>
                                                <strong style="color: ${colors.text}; font-size: 14px;">${signal.signal_type}</strong>
                                                ${signal.symbol ? `<span style="color: #60a5fa; margin-left: 10px; font-size: 12px;">${signal.symbol}</span>` : ''}
                                            </div>
                                            <span style="color: #9ca3af; font-size: 11px;">${formatTimestamp(signal.timestamp)}</span>
                                        </div>
                                        <div style="color: #9ca3af; font-size: 12px; margin-top: 5px;">${signal.message}</div>
                                    </div>
                                `;
                            }).join('')}
                        ` : '<p style="color: #9ca3af; text-align: center; padding: 20px;">No signals yet</p>'}
                    </div>
                </div>
            `;

            // Metrics Card
            html += `
                <div class="card">
                    <h2>üìä Performance Metrics</h2>
                    <div class="metric">
                        <span class="metric-label">Equity</span>
                        <span class="metric-value">${formatCurrency(data.metrics.equity)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total PnL</span>
                        <span class="metric-value ${data.metrics.total_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(data.metrics.total_pnl)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Realized PnL</span>
                        <span class="metric-value ${data.metrics.realized_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(data.metrics.realized_pnl)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Unrealized PnL</span>
                        <span class="metric-value ${data.metrics.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(data.metrics.unrealized_pnl)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Daily PnL</span>
                        <span class="metric-value ${data.metrics.daily_pnl >= 0 ? 'positive' : 'negative'}">
                            ${formatCurrency(data.metrics.daily_pnl)}
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Max Drawdown</span>
                        <span class="metric-value negative">
                            ${formatCurrency(data.metrics.max_drawdown)} (${formatPercent(data.metrics.max_drawdown_pct)})
                        </span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Trades</span>
                        <span class="metric-value">${data.metrics.total_trades}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Trades Today</span>
                        <span class="metric-value">${data.metrics.trades_today}</span>
                    </div>
                    ${data.metrics.sharpe_ratio ? `
                    <div class="metric">
                        <span class="metric-label">Sharpe Ratio</span>
                        <span class="metric-value">${formatNumber(data.metrics.sharpe_ratio, 2)}</span>
                    </div>
                    ` : ''}
                    ${data.metrics.kill_switch_active ? `
                    <div class="metric">
                        <span class="metric-label">Kill Switch</span>
                        <span class="metric-value negative">ACTIVE: ${data.metrics.kill_switch_reason || 'Unknown'}</span>
                    </div>
                    ` : ''}
                </div>
            `;

            // Live Prices Card
            const prices = data.prices || {};
            
            // Check for price changes and add animation class
            const priceItems = Object.entries(prices).map(([symbol, price]) => {
                const prevPrice = previousPrices[symbol];
                
                // More sensitive price change detection (0.001 instead of 0.01)
                const priceChanged = prevPrice && prevPrice.mid_price && price.mid_price && 
                                     Math.abs(prevPrice.mid_price - price.mid_price) > 0.001;
                
                const priceDirection = prevPrice && price.mid_price && prevPrice.mid_price ? 
                                     (price.mid_price > prevPrice.mid_price ? 'up' : 
                                      price.mid_price < prevPrice.mid_price ? 'down' : null) : null;
                
                // Determine color based on price direction
                let priceColor = '#4ade80'; // default green
                if (priceDirection === 'up') {
                    priceColor = '#4ade80'; // green for up
                } else if (priceDirection === 'down') {
                    priceColor = '#ef4444'; // red for down
                }
                
                // Debug log for price changes
                if (priceChanged && prevPrice) {
                    console.log(`Price changed for ${symbol}:`, {
                        previous: prevPrice.mid_price,
                        current: price.mid_price,
                        change: price.mid_price - prevPrice.mid_price,
                        direction: priceDirection
                    });
                }
                
                return {
                    symbol,
                    price,
                    priceChanged,
                    priceColor
                };
            });
            
            // Update previous prices (deep copy to avoid reference issues)
            previousPrices = {};
            Object.entries(prices).forEach(([symbol, price]) => {
                previousPrices[symbol] = {
                    mid_price: price.mid_price,
                    best_bid: price.best_bid,
                    best_ask: price.best_ask,
                    spread: price.spread,
                    spread_bps: price.spread_bps
                };
            });
            
            html += `
                <div class="card" id="livePricesCard">
                    <h2>üí∞ Live Prices</h2>
                    <div id="livePricesContainer">
                        ${priceItems.length > 0 ? `
                            ${priceItems.map(({symbol, price, priceChanged, priceColor}) => `
                                <div class="price-item ${priceChanged ? 'price-updated' : ''}" 
                                     data-symbol="${symbol}"
                                     id="price-item-${symbol}"
                                     style="padding: 10px; border-bottom: 1px solid #2a2a4a; ${priceChanged ? 'background: #1a1a3a;' : ''}">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                        <strong style="color: #60a5fa; font-size: 16px;">${symbol}</strong>
                                        <span class="price-value" id="price-mid-${symbol}" style="font-size: 20px; font-weight: bold; color: ${priceColor};">
                                            ${price.mid_price ? formatCurrency(price.mid_price) : 'N/A'}
                                        </span>
                                    </div>
                                    <div style="display: flex; gap: 15px; font-size: 12px; color: #9ca3af;">
                                        <span>Bid: <span id="price-bid-${symbol}" style="color: #ef4444;">${price.best_bid ? formatCurrency(price.best_bid) : 'N/A'}</span></span>
                                        <span>Ask: <span id="price-ask-${symbol}" style="color: #4ade80;">${price.best_ask ? formatCurrency(price.best_ask) : 'N/A'}</span></span>
                                        <span>Spread: <span id="price-spread-${symbol}" style="color: #fbbf24;">${price.spread_bps ? formatNumber(price.spread_bps, 2) + ' bps' : 'N/A'}</span></span>
                                    </div>
                                </div>
                            `).join('')}
                        ` : '<p style="color: #9ca3af; text-align: center; padding: 20px;">No price data available</p>'}
                    </div>
                </div>
            `;

            // Positions Card
            const positions = Object.values(data.positions || {});
            html += `
                <div class="card">
                    <h2>üìà Positions</h2>
                    ${positions.length > 0 ? `
                        <table class="positions-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Quantity</th>
                                    <th>Entry</th>
                                    <th>Mark</th>
                                    <th>uPnL</th>
                                    <th>rPnL</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${positions.map(pos => `
                                    <tr>
                                        <td>${pos.symbol}</td>
                                        <td>${formatNumber(pos.quantity, 6)}</td>
                                        <td>${formatCurrency(pos.entry_price)}</td>
                                        <td>${formatCurrency(pos.mark_price)}</td>
                                        <td class="${pos.unrealized_pnl >= 0 ? 'positive' : 'negative'}">
                                            ${formatCurrency(pos.unrealized_pnl)}
                                        </td>
                                        <td class="${pos.realized_pnl >= 0 ? 'positive' : 'negative'}">
                                            ${formatCurrency(pos.realized_pnl)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '<p style="color: #9ca3af; text-align: center; padding: 20px;">No open positions</p>'}
                </div>
            `;

            // Risk Scaling Card
            const riskScaling = data.risk_scaling || {};
            html += `
                <div class="card">
                    <h2>‚öñÔ∏è Risk Scaling</h2>
                    ${Object.keys(riskScaling).length > 0 ? `
                        ${Object.entries(riskScaling).map(([symbol, info]) => `
                            <div class="metric">
                                <span class="metric-label">${symbol}</span>
                                <span class="metric-value">
                                    ${formatNumber(info.multiplier, 3)}x
                                    ${info.is_risk_off ? '<span class="badge risk-off">RISK-OFF</span>' : ''}
                                </span>
                            </div>
                        `).join('')}
                    ` : '<p style="color: #9ca3af; text-align: center; padding: 20px;">No risk scaling data</p>'}
                </div>
            `;

            // Recent Trades Card
            html += `
                <div class="card full-width">
                    <h2>üí± Recent Trades</h2>
                    <div class="trades-list">
                        ${data.trades && data.trades.length > 0 ? `
                            ${data.trades.map(trade => `
                                <div class="trade-item">
                                    <div>
                                        <span class="trade-side ${trade.side}">${trade.side}</span>
                                        <strong>${trade.symbol}</strong>
                                        <span style="margin: 0 10px;">${formatNumber(trade.quantity, 6)} @ ${formatCurrency(trade.price)}</span>
                                    </div>
                                    <span class="timestamp">${formatTimestamp(trade.timestamp)}</span>
                                </div>
                            `).join('')}
                        ` : '<p style="color: #9ca3af; text-align: center; padding: 20px;">No trades yet</p>'}
                    </div>
                </div>
            `;

            // Logs Card
            html += `
                <div class="card full-width">
                    <h2>üìã Live Logs</h2>
                    <div class="logs-container" id="logsContainer" style="max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                        ${data.logs && data.logs.length > 0 ? `
                            ${data.logs.map(log => {
                                const levelColor = {
                                    'DEBUG': '#6b7280',
                                    'INFO': '#60a5fa',
                                    'WARNING': '#fbbf24',
                                    'ERROR': '#ef4444',
                                    'CRITICAL': '#dc2626'
                                }[log.level] || '#9ca3af';
                                
                                // Check if this is a signal log
                                const isSignal = log.is_signal || false;
                                let signalStyle = '';
                                if (isSignal) {
                                    const signalType = log.signal_type || '';
                                    if (signalType.includes('LONG') || signalType === 'ENTER_LONG') {
                                        signalStyle = 'background: #1a3a1a; border-left: 3px solid #4ade80; padding-left: 12px;';
                                    } else if (signalType.includes('SHORT') || signalType === 'ENTER_SHORT') {
                                        signalStyle = 'background: #3a1a1a; border-left: 3px solid #ef4444; padding-left: 12px;';
                                    } else {
                                        signalStyle = 'background: #3a3a1a; border-left: 3px solid #fbbf24; padding-left: 12px;';
                                    }
                                }
                                
                                return `
                                    <div class="log-entry" style="padding: 4px 8px; border-bottom: 1px solid #2a2a4a; color: ${levelColor}; ${signalStyle}">
                                        ${isSignal ? '<span style="font-size: 14px; margin-right: 5px;">‚ö°</span>' : ''}
                                        <span style="color: #6b7280; margin-right: 8px;">[${log.level}]</span>
                                        <span style="color: #9ca3af; margin-right: 8px;">${formatTimestamp(log.timestamp)}</span>
                                        <span>${log.message}</span>
                                    </div>
                                `;
                            }).join('')}
                        ` : '<p style="color: #9ca3af; text-align: center; padding: 20px;">No logs yet</p>'}
                    </div>
                </div>
            `;

            // Backtest Card
            html += `
                <div class="card full-width">
                    <h2>üß™ Backtest</h2>
                    <div id="backtestForm" style="padding: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 12px;">Symbol</label>
                                <select id="backtestSymbol" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 4px; color: #e0e0e0;">
                                    <option value="BTCUSDT">BTCUSDT</option>
                                    <option value="ETHUSDT">ETHUSDT</option>
                                    <option value="BNBUSDT">BNBUSDT</option>
                                    <option value="SOLUSDT">SOLUSDT</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 12px;">Start Date</label>
                                <input type="date" id="backtestStartDate" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 4px; color: #e0e0e0;" value="2024-01-01">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 12px;">End Date</label>
                                <input type="date" id="backtestEndDate" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 4px; color: #e0e0e0;" value="2024-01-07">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 12px;">Spread (bps)</label>
                                <input type="number" id="backtestSpread" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 4px; color: #e0e0e0;" value="8" step="0.1" min="1" max="100">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; color: #9ca3af; font-size: 12px;">Order Notional %</label>
                                <input type="number" id="backtestNotional" style="width: 100%; padding: 8px; background: #0f0f23; border: 1px solid #2a2a4a; border-radius: 4px; color: #e0e0e0;" value="0.01" step="0.001" min="0.001" max="1">
                            </div>
                        </div>
                        <button id="runBacktestBtn" style="width: 100%; padding: 12px; background: #4ade80; color: #0f0f23; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 14px;">
                            Run Backtest
                        </button>
                        <div id="backtestLoader" style="margin-top: 20px; display: none; text-align: center; padding: 20px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #2a2a4a; border-top: 4px solid #4ade80; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="color: #9ca3af; margin-top: 10px;">Running backtest... Please wait</p>
                        </div>
                        <div id="backtestResults" style="margin-top: 20px; display: none;">
                            <h3 style="color: #60a5fa; margin-bottom: 15px; border-bottom: 2px solid #2a2a4a; padding-bottom: 10px;">üìä Backtest Results</h3>
                            <div id="backtestResultsContent" style="background: #0f0f23; padding: 20px; border-radius: 4px;"></div>
                        </div>
                    </div>
                </div>
            `;

            // Check if prices container exists - if so, update only prices without rewriting HTML
            const existingPricesContainer = document.getElementById('livePricesContainer');
            const pricesContainerExists = existingPricesContainer !== null;
            
            if (pricesContainerExists && priceItems.length > 0) {
                // Update only prices without rewriting entire HTML
                priceItems.forEach(({symbol, price, priceChanged, priceColor}) => {
                    const midPriceEl = document.getElementById(`price-mid-${symbol}`);
                    const bidPriceEl = document.getElementById(`price-bid-${symbol}`);
                    const askPriceEl = document.getElementById(`price-ask-${symbol}`);
                    const spreadEl = document.getElementById(`price-spread-${symbol}`);
                    const priceItemEl = document.getElementById(`price-item-${symbol}`);
                    
                    if (midPriceEl) {
                        const newPrice = price.mid_price ? formatCurrency(price.mid_price) : 'N/A';
                        const currentPrice = midPriceEl.textContent.trim();
                        if (currentPrice !== newPrice) {
                            midPriceEl.textContent = newPrice;
                            midPriceEl.style.color = priceColor;
                            console.log(`Price updated for ${symbol}: ${currentPrice} -> ${newPrice}`);
                            if (priceChanged && priceItemEl) {
                                priceItemEl.classList.add('price-updated');
                                priceItemEl.style.background = '#1a1a3a';
                                setTimeout(() => {
                                    priceItemEl.classList.remove('price-updated');
                                    priceItemEl.style.background = '';
                                }, 500);
                            }
                        }
                    }
                    if (bidPriceEl && price.best_bid) {
                        const newBid = formatCurrency(price.best_bid);
                        if (bidPriceEl.textContent.trim() !== newBid) {
                            bidPriceEl.textContent = newBid;
                        }
                    }
                    if (askPriceEl && price.best_ask) {
                        const newAsk = formatCurrency(price.best_ask);
                        if (askPriceEl.textContent.trim() !== newAsk) {
                            askPriceEl.textContent = newAsk;
                        }
                    }
                    if (spreadEl && price.spread_bps) {
                        const newSpread = formatNumber(price.spread_bps, 2) + ' bps';
                        if (spreadEl.textContent.trim() !== newSpread) {
                            spreadEl.textContent = newSpread;
                        }
                    }
                });
                
                // Check if we need to add new price items (for newly selected coins)
                const existingSymbols = Array.from(document.querySelectorAll('.price-item')).map(el => el.getAttribute('data-symbol'));
                priceItems.forEach(({symbol, price, priceChanged, priceColor}) => {
                    if (!existingSymbols.includes(symbol)) {
                        // New symbol - need to add it to the container
                        const container = existingPricesContainer;
                        if (container) {
                            const newItem = document.createElement('div');
                            newItem.className = `price-item ${priceChanged ? 'price-updated' : ''}`;
                            newItem.setAttribute('data-symbol', symbol);
                            newItem.id = `price-item-${symbol}`;
                            newItem.style.cssText = `padding: 10px; border-bottom: 1px solid #2a2a4a; ${priceChanged ? 'background: #1a1a3a;' : ''}`;
                            newItem.innerHTML = `
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <strong style="color: #60a5fa; font-size: 16px;">${symbol}</strong>
                                    <span class="price-value" id="price-mid-${symbol}" style="font-size: 20px; font-weight: bold; color: ${priceColor};">
                                        ${price.mid_price ? formatCurrency(price.mid_price) : 'N/A'}
                                    </span>
                                </div>
                                <div style="display: flex; gap: 15px; font-size: 12px; color: #9ca3af;">
                                    <span>Bid: <span id="price-bid-${symbol}" style="color: #ef4444;">${price.best_bid ? formatCurrency(price.best_bid) : 'N/A'}</span></span>
                                    <span>Ask: <span id="price-ask-${symbol}" style="color: #4ade80;">${price.best_ask ? formatCurrency(price.best_ask) : 'N/A'}</span></span>
                                    <span>Spread: <span id="price-spread-${symbol}" style="color: #fbbf24;">${price.spread_bps ? formatNumber(price.spread_bps, 2) + ' bps' : 'N/A'}</span></span>
                                </div>
                            `;
                            container.appendChild(newItem);
                        }
                    }
                });
                
                // Remove price items that are no longer in the list
                existingSymbols.forEach(symbol => {
                    if (!priceItems.find(item => item.symbol === symbol)) {
                        const itemEl = document.getElementById(`price-item-${symbol}`);
                        if (itemEl) {
                            itemEl.remove();
                        }
                    }
                });
                
                // Don't rewrite HTML if prices container exists - just update other parts separately
                // We'll update other cards separately
                return; // Skip full HTML rewrite
            }
            
            // Full HTML rewrite (first time or when prices container doesn't exist)
            grid.innerHTML = html;
            
            // Auto-scroll logs to bottom
            const logsContainer = document.getElementById('logsContainer');
            if (logsContainer) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
            
            // Setup backtest button handler - only attach once using event delegation
            if (!backtestListenerAttached) {
                backtestListenerAttached = true;
                
                // Use event delegation on the grid to handle clicks
                grid.addEventListener('click', async function(e) {
                    if (e.target && e.target.id === 'runBacktestBtn') {
                        const backtestBtn = e.target;
                    console.log('Backtest button clicked');
                    
                    const symbol = document.getElementById('backtestSymbol')?.value || 'BTCUSDT';
                    const startDate = document.getElementById('backtestStartDate')?.value || '2024-01-01';
                    const endDate = document.getElementById('backtestEndDate')?.value || '2024-01-07';
                    const spread = parseFloat(document.getElementById('backtestSpread')?.value || '8');
                    const notional = parseFloat(document.getElementById('backtestNotional')?.value || '0.01');
                    
                    console.log('Backtest params:', { symbol, startDate, endDate, spread, notional });
                    
                    // Update state and hide previous results
                    backtestState.resultsVisible = false;
                    backtestState.loaderVisible = true;
                    
                    const resultsDiv = document.getElementById('backtestResults');
                    const loaderDiv = document.getElementById('backtestLoader');
                    if (resultsDiv) {
                        resultsDiv.style.display = 'none';
                        console.log('Hiding previous results');
                    }
                    
                    // Show loader
                    if (loaderDiv) {
                        loaderDiv.style.display = 'block';
                        console.log('Showing loader');
                    } else {
                        console.error('Loader div not found!');
                    }
                    
                    backtestBtn.disabled = true;
                    backtestBtn.textContent = 'Running...';
                    
                    try {
                        console.log('Sending backtest request...');
                        // Use current window location to support any port
                        const apiUrl = `${window.location.protocol}//${window.location.host}/api/backtest`;
                        console.log('API URL:', apiUrl);
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                symbol,
                                start_date: startDate,
                                end_date: endDate,
                                spread_bps: spread,
                                order_notional_pct: notional
                            })
                        });
                        
                        console.log('Response status:', response.status);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Response error:', errorText);
                            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }
                        
                        const results = await response.json();
                        console.log('Backtest results received:', results);
                        
                        // Update state - hide loader, show results
                        backtestState.loaderVisible = false;
                        backtestState.resultsVisible = true;
                        
                        // Hide loader
                        const loaderDiv = document.getElementById('backtestLoader');
                        if (loaderDiv) {
                            loaderDiv.style.display = 'none';
                            console.log('Hiding loader');
                        }
                        
                        const resultsDiv = document.getElementById('backtestResults');
                        const resultsContent = document.getElementById('backtestResultsContent');
                        if (!resultsContent) {
                            console.error('Results content div not found!');
                            return;
                        }
                        
                        let resultsHtml = '';
                        if (results.error) {
                            resultsHtml = `
                                <div style="color: #ef4444; margin-bottom: 15px; padding: 15px; background: #1a1a3a; border-left: 4px solid #ef4444; border-radius: 4px;">
                                    <strong style="font-size: 16px;">‚ùå Error</strong>
                                    <p style="margin-top: 8px; color: #e0e0e0;">${results.error}</p>
                                </div>
                                ${results.snapshots_processed === 0 ? `
                                    <div style="color: #fbbf24; margin-top: 15px; padding: 15px; background: #1a1a3a; border-left: 4px solid #fbbf24; border-radius: 4px;">
                                        <strong style="font-size: 14px;">üí° Tip: Backtest verisi bulunamadƒ±</strong>
                                        <p style="margin-top: 8px; color: #e0e0e0; font-size: 12px;">Veriyi indirmek i√ßin terminal'de ≈üu komutu √ßalƒ±≈ütƒ±r:</p>
                                        <code style="color: #60a5fa; margin-top: 8px; display: block; padding: 8px; background: #0f0f23; border-radius: 4px; font-family: monospace; font-size: 11px;">python scripts/download_backtest_data.py --symbol ${symbol} --start-date ${startDate} --end-date ${endDate}</code>
                                    </div>
                                ` : ''}
                            `;
                        } else {
                            const pnlColor = results.total_pnl >= 0 ? '#4ade80' : '#ef4444';
                            const pnlIcon = results.total_pnl >= 0 ? 'üìà' : 'üìâ';
                            
                            resultsHtml = `
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #1a1a3a; padding: 15px; border-radius: 4px; border-left: 4px solid #60a5fa;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Symbol</div>
                                        <div style="color: #e0e0e0; font-size: 18px; font-weight: 600;">${results.symbol || symbol}</div>
                                    </div>
                                    <div style="background: #1a1a3a; padding: 15px; border-radius: 4px; border-left: 4px solid #60a5fa;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Period</div>
                                        <div style="color: #e0e0e0; font-size: 14px;">${startDate} to ${endDate}</div>
                                    </div>
                                    <div style="background: #1a1a3a; padding: 15px; border-radius: 4px; border-left: 4px solid #60a5fa;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Snapshots</div>
                                        <div style="color: #e0e0e0; font-size: 18px; font-weight: 600;">${results.snapshots_processed || 0}</div>
                                    </div>
                                    <div style="background: #1a1a3a; padding: 15px; border-radius: 4px; border-left: 4px solid #60a5fa;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Total Trades</div>
                                        <div style="color: #e0e0e0; font-size: 18px; font-weight: 600;">${results.total_trades || 0}</div>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                    <div style="background: #1a1a3a; padding: 20px; border-radius: 4px; border-left: 4px solid ${pnlColor};">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Total PnL</div>
                                        <div style="color: ${pnlColor}; font-size: 24px; font-weight: 700;">${pnlIcon} ${formatCurrency(results.total_pnl || 0)}</div>
                                    </div>
                                    <div style="background: #1a1a3a; padding: 20px; border-radius: 4px; border-left: 4px solid #60a5fa;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Initial Equity</div>
                                        <div style="color: #e0e0e0; font-size: 20px; font-weight: 600;">${formatCurrency(results.initial_equity || 0)}</div>
                                    </div>
                                    <div style="background: #1a1a3a; padding: 20px; border-radius: 4px; border-left: 4px solid #60a5fa;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Final Equity</div>
                                        <div style="color: #e0e0e0; font-size: 20px; font-weight: 600;">${formatCurrency(results.equity_final || 0)}</div>
                                    </div>
                                    <div style="background: #1a1a3a; padding: 20px; border-radius: 4px; border-left: 4px solid #ef4444;">
                                        <div style="color: #9ca3af; font-size: 12px; margin-bottom: 8px;">Max Drawdown</div>
                                        <div style="color: #ef4444; font-size: 18px; font-weight: 600;">${formatCurrency(results.max_drawdown || 0)}</div>
                                        <div style="color: #9ca3af; font-size: 12px; margin-top: 4px;">${formatPercent(results.max_drawdown_pct || 0)}</div>
                                    </div>
                                </div>
                                
                                ${results.sharpe_ratio ? `
                                <div style="background: #1a1a3a; padding: 15px; border-radius: 4px; border-left: 4px solid #fbbf24;">
                                    <div style="color: #9ca3af; font-size: 12px; margin-bottom: 5px;">Sharpe Ratio</div>
                                    <div style="color: #fbbf24; font-size: 20px; font-weight: 600;">${formatNumber(results.sharpe_ratio, 2)}</div>
                                </div>
                                ` : ''}
                            `;
                        }
                        
                        // Update state and DOM
                        backtestState.resultsContent = resultsHtml;
                        if (resultsContent) {
                            resultsContent.innerHTML = resultsHtml;
                        }
                        if (resultsDiv) {
                            resultsDiv.style.display = 'block';
                            console.log('Showing results div');
                        } else {
                            console.error('Results div not found!');
                        }
                    } catch (error) {
                        console.error('Backtest error:', error);
                        
                        // Update state
                        backtestState.loaderVisible = false;
                        backtestState.resultsVisible = true;
                        
                        const errorHtml = `
                            <div style="color: #ef4444; padding: 15px; background: #1a1a3a; border-left: 4px solid #ef4444; border-radius: 4px;">
                                <strong style="font-size: 16px;">‚ùå Error</strong>
                                <p style="margin-top: 8px; color: #e0e0e0;">${error.message}</p>
                                <small style="color: #9ca3af; font-size: 11px;">Check browser console (F12) for details</small>
                            </div>`;
                        
                        backtestState.resultsContent = errorHtml;
                        
                        const loaderDiv = document.getElementById('backtestLoader');
                        const resultsDiv = document.getElementById('backtestResults');
                        const resultsContent = document.getElementById('backtestResultsContent');
                        
                        if (loaderDiv) {
                            loaderDiv.style.display = 'none';
                        }
                        if (resultsContent) {
                            resultsContent.innerHTML = errorHtml;
                        }
                        if (resultsDiv) {
                            resultsDiv.style.display = 'block';
                        }
                    } finally {
                        backtestBtn.disabled = false;
                        backtestBtn.textContent = 'Run Backtest';
                    }
                    } // End of if (e.target && e.target.id === 'runBacktestBtn')
                }); // End of grid.addEventListener
            } // End of if (!backtestListenerAttached)
            
            // Restore backtest state after HTML update
            const loaderDiv = document.getElementById('backtestLoader');
            const resultsDiv = document.getElementById('backtestResults');
            const resultsContent = document.getElementById('backtestResultsContent');
            
            if (loaderDiv) {
                loaderDiv.style.display = backtestState.loaderVisible ? 'block' : 'none';
            }
            if (resultsDiv) {
                resultsDiv.style.display = backtestState.resultsVisible ? 'block' : 'none';
            }
            if (resultsContent && backtestState.resultsContent) {
                resultsContent.innerHTML = backtestState.resultsContent;
            }
            
            // Setup coin selection handler (use event delegation)
            if (!window.coinSelectionListenerAttached) {
                window.coinSelectionListenerAttached = true;
                grid.addEventListener('change', function(e) {
                    // Update client state when checkbox changes
                    if (e.target && e.target.classList.contains('coin-checkbox')) {
                        const checkbox = e.target;
                        if (checkbox.checked) {
                            if (!coinSelectionState.selectedCoins.includes(checkbox.value)) {
                                coinSelectionState.selectedCoins.push(checkbox.value);
                            }
                        } else {
                            coinSelectionState.selectedCoins = coinSelectionState.selectedCoins.filter(c => c !== checkbox.value);
                        }
                    }
                });
                
                grid.addEventListener('click', async function(e) {
                    if (e.target && e.target.id === 'updateCoinsBtn') {
                        const updateCoinsBtn = e.target;
                        // Use current client state (which includes any unchecked boxes)
                        const checkboxes = document.querySelectorAll('.coin-checkbox');
                        const selectedCoins = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
                        
                        // Update client state
                        coinSelectionState.selectedCoins = selectedCoins;
                        
                        try {
                            const response = await fetch(`${window.location.protocol}//${window.location.host}/api/select-coins`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ coins: selectedCoins })
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                console.log('Selected coins updated:', result.selected_coins);
                                // Update client state with server response
                                coinSelectionState.selectedCoins = result.selected_coins;
                                // Show success message
                                updateCoinsBtn.textContent = '‚úì Updated!';
                                updateCoinsBtn.style.background = '#4ade80';
                                setTimeout(() => {
                                    updateCoinsBtn.textContent = 'Update Selected Coins';
                                    updateCoinsBtn.style.background = '#60a5fa';
                                }, 2000);
                            }
                        } catch (error) {
                            console.error('Error updating selected coins:', error);
                            updateCoinsBtn.textContent = '‚úó Error';
                            updateCoinsBtn.style.background = '#ef4444';
                            setTimeout(() => {
                                updateCoinsBtn.textContent = 'Update Selected Coins';
                                updateCoinsBtn.style.background = '#60a5fa';
                            }, 2000);
                        }
                    }
                });
            }
            
            // Restore checkbox states after HTML update
            const checkboxes = document.querySelectorAll('.coin-checkbox');
            checkboxes.forEach(cb => {
                if (coinSelectionState.selectedCoins.includes(cb.value)) {
                    cb.checked = true;
                }
            });
            
            // After HTML update, ensure price elements are properly updated
            // This runs after grid.innerHTML, so elements exist now
            setTimeout(() => {
                priceItems.forEach(({symbol, price, priceChanged, priceColor}) => {
                    const midPriceEl = document.getElementById(`price-mid-${symbol}`);
                    const priceItemEl = document.getElementById(`price-item-${symbol}`);
                    
                    if (midPriceEl && priceChanged) {
                        midPriceEl.style.color = priceColor;
                        if (priceItemEl) {
                            priceItemEl.classList.add('price-updated');
                            priceItemEl.style.background = '#1a1a3a';
                            setTimeout(() => {
                                priceItemEl.classList.remove('price-updated');
                                priceItemEl.style.background = '';
                            }, 500);
                        }
                    }
                });
            }, 10);
        }

        // Initial connection
        connectWebSocket();

        // Fallback: try to fetch initial state via HTTP
        fetch('/api/state')
            .then(res => res.json())
            .then(data => updateDashboard(data))
            .catch(err => console.error('Error fetching initial state:', err));
    </script>
</body>
</html>

